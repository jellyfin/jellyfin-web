# PWA Optimization Review & Roadmap

## Executive Summary
The current PWA implementation in `jellyfin-web` has been upgraded to use **Workbox**, replacing the manual service worker logic. This ensures reliable offline support, better caching strategies, and automatic precaching of build assets.

## Completed Optimizations (Phase 1 & 2)

### 1. Unified Service Worker Registration
- **Action:** Consolidated registration logic into `src/utils/pwaUpdate.js`.
- **Details:** Removed redundant `registerServiceWorker` from `src/index.jsx`. Added safety checks (`__WEBPACK_SERVE__`, `appMode`) to the unified manager.
- **Benefit:** Prevents race conditions and double-registration. Ensures SW is only active in production/supported environments.

### 2. Migration to Workbox
- **Action:** Implemented `src/sw.js` using Workbox libraries (`workbox-precaching`, `workbox-routing`, `workbox-strategies`).
- **Action:** Updated Webpack configuration to use `InjectManifest` from `workbox-webpack-plugin`.
- **Benefit:**
    - **Precaching:** Automatically caches all JS/CSS/HTML assets generated by the build (via `self.__WB_MANIFEST`).
    - **Smart Strategies:**
        - **API:** `NetworkFirst` (falls back to cache if offline).
        - **Images:** `CacheFirst` (with 30-day expiration).
        - **Fonts:** `CacheFirst` (with 1-year expiration).
    - **Offline Fallback:** App shell (`index.html`) is always served for navigation requests.

### 3. Cleanup
- **Action:** Renamed legacy `src/serviceworker.js` to `src/serviceworker.backup.js`.
- **Action:** Removed manual `serviceworker` chunk injection from `HtmlWebpackPlugin` to avoid `<script>` tag pollution (SW should be registered, not loaded as a script).

## Verification
- **Build Check:** Ran `npm run build:check` (tsc). No new errors introduced.
- **File Structure:**
    - Source: `src/sw.js`
    - Output: `dist/serviceworker.js` (generated by build)

## Next Steps (Phase 3 - Future)
- **Background Sync:** Implement `workbox-background-sync` for offline actions (e.g., "Mark as Played").
- **Periodic Sync:** Keep "Next Up" fresh in the background.
- **UI Refactor:** Update the "Update Available" banner in `pwaUpdate.js` to use React components (`Toast` or `Dialog`) instead of raw DOM injection.